<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>מחשבון חיסכון משפחתי</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Assistant', sans-serif; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; appearance: textfield; }
    @media print {
      body { background: white; font-family: 'Assistant', sans-serif; }
      .container { margin: 0; padding: 0; box-shadow: none; }
      .bg-white { background: white; box-shadow: none; }
      .text-center { text-align: center; }
      button { display: none; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #ddd; padding: 8px; }
      th { background-color: #f2f2f2; text-align: center; }
      .max-h-64 { max-height: none; overflow: visible; }
      .overflow-y-auto { overflow: visible; }
      #wedding-costs-container { max-height: none; overflow: visible; }
      #children-ages-container { max-height: none; overflow: visible; }
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 mb-6">
      <div class="container mx-auto px-4">
        <div class="flex items-center justify-between h-16">
          <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium">← חזרה לדף הראשי</a>
          <h1 class="text-xl font-bold text-gray-800">מחשבון חיסכון משפחתי</h1>
          <div class="w-24"></div> <!-- Spacer for center alignment -->
        </div>
      </div>
    </nav>  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white p-6 rounded-2xl shadow-lg">
            
      <div class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">מחשבון חיסכון משפחתי</h1>
        <p class="text-gray-600 mt-2">הכלי מחשב את צמיחת הקרן המשפחתית.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6 mb-8 border-t border-b border-gray-200 py-8">
        <div class="space-y-4 p-4 bg-gray-50 rounded-lg">
          <h3 class="font-bold text-lg text-gray-700 border-b pb-2">פרמטרים ראשיים</h3>
          <div>
            <label for="initialMarriedCount" class="block text-sm font-medium text-gray-700">מספר ילדים נשואים כעת</label>
            <input type="number" id="initialMarriedCount" value="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label for="annualYield" class="block text-sm font-medium text-gray-700">תשואה שנתית ממוצעת (%)</label>
            <input type="number" id="annualYield" value="10" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
          </div>
           <div>
            <label for="contributionPerMarriedChild" class="block text-sm font-medium text-gray-700">תרומה חודשית מכל ילד נשוי</label>
            <input type="number" id="contributionPerMarriedChild" value="250" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
          </div>
        </div>

        <div class="space-y-2 p-4 bg-gray-50 rounded-lg">
          <h3 class="font-bold text-lg text-gray-700 border-b pb-2 mb-3">השתתפות נטו לכל חתונה (10 ילדים)</h3>
          <div id="wedding-costs-container" class="grid grid-cols-2 gap-x-4 gap-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </div>

        <div class="space-y-2 p-4 bg-gray-50 rounded-lg">
          <h3 class="font-bold text-lg text-gray-700 border-b pb-2 mb-3">גילאי 10 הילדים שאינם נשואים</h3>
          <div id="children-ages-container" class="grid grid-cols-2 gap-x-4 gap-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse border border-gray-300">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-3 border text-sm font-semibold text-gray-700">שנה</th>
              <th class="p-3 border text-sm font-semibold text-gray-700">יתרת פתיחה</th>
              <th class="p-3 border text-sm font-semibold text-gray-700">הכנסה מילדים</th>
              <th class="p-3 border text-sm font-semibold text-gray-700">צמיחה (תשואה)</th>
              <th class="p-3 border text-sm font-semibold text-gray-700">השתתפות בחתונה נטו</th>
              <th class="p-3 border text-sm font-semibold text-gray-700">יתרת סגירה</th>
            </tr>
          </thead>
          <tbody id="results-table-body" class="bg-white"></tbody>
        </table>
      </div>

      <div class="flex items-center justify-center gap-3 mt-6">
        <button onclick="window.print()" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
          הדפס
        </button>
        <button onclick="resetSavedState()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
          איפוס נתונים שמורים
        </button>
      </div>
      
      <div class="text-center mt-8 p-4 bg-gray-100 rounded-lg shadow-md">
        <p class="text-gray-800 text-lg leading-relaxed">
          "ובחיי אדם ובשו"ת חתם סופר פסקו שאם להוריו חסר כדי פרנסתם ובמיוחד בימינו שההורים שקועים בחובות גדולים ומתקשים לחיות כהרגלם חייבים הילדים לתת להם את כספי המעשרות שברשותם, עד שיהיה להם כדי כל מחסורם ברווח. ומרן הגר"ש וואזנר זצוק"ל פסק שאביו קודם בכל מה שצריך אפילו לעני הזקוק ללחם ומים."
        </p>
        <p class="text-gray-700 text-md mt-4 font-semibold">
          "הַתּוֹרָה וְהַמַּעֲשֵׂר וְהַשַּׁבָּת הֵם נוֹתְנִים חַיִּים גַּשְׁמִיִּים גַם כֵּן" (ספר המידות).
        </p>
        <p class="text-gray-700 text-md mt-4">
          ניתן לבצע הוראת קבע באשראי או בבנק דרך עמדות נדרים פלוס - חיפוש קופה: "השקעה לדורות אח לאח" או בטלפון נדרים פון במספר: 037630585, שלוחה 8048.
        </p>
      </div>
    </div>
  </div>

  <script>
    // Persist all inputs across hard refresh using localStorage only
    const STATE_KEY = 'familySavingsState.v1';
    
    const TOTAL_YEARS = 25; 
    const WEDDING_AGE = 18;
    const INITIAL_CHILDREN_AGES = [17, 16, 14, 13, 11, 8, 6, 4, 2, 0];
    const INITIAL_WEDDING_COSTS = [10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 0];

    const initialMarriedCountEl = document.getElementById('initialMarriedCount');
    const annualYieldEl = document.getElementById('annualYield');
    const contributionPerMarriedChildEl = document.getElementById('contributionPerMarriedChild');
    const resultsTableBody = document.getElementById('results-table-body');
    const weddingCostsContainer = document.getElementById('wedding-costs-container');
    const childrenAgesContainer = document.getElementById('children-ages-container');

    let weddingCostInputs = [];
    let childrenAgeInputs = [];

    function formatCurrency(num) { return Math.round(num).toLocaleString('he-IL'); }

    function getDefaultState() {
      return {
        initialMarriedCount: 4,
        annualYield: 10,
        contributionPerMarriedChild: 250,
        weddingCosts: [...INITIAL_WEDDING_COSTS],
        childrenAges: [...INITIAL_CHILDREN_AGES],
      };
    }

    // Firebase variables
    let db = null;
    let isFirebaseEnabled = false;

    // Initialize Firebase
    async function initializeFirebase() {
      try {
        const { db: firebaseDb, handleFirebaseError, checkOnlineStatus } = await import('../firebase-config.js');
        const { doc, setDoc, getDoc, collection } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
        
        db = firebaseDb;
        isFirebaseEnabled = checkOnlineStatus();
        window.handleFirebaseError = handleFirebaseError;
        window.checkOnlineStatus = checkOnlineStatus;
        window.firestoreDoc = doc;
        window.firestoreSetDoc = setDoc;
        window.firestoreGetDoc = getDoc;
        window.firestoreCollection = collection;
        
        console.log('Firebase initialized successfully');
      } catch (error) {
        console.warn('Firebase not available, working offline only:', error);
        isFirebaseEnabled = false;
      }
    }

    async function loadState() {
      try {
        let state = null;
        
        // Try loading from Firebase first
        if (isFirebaseEnabled && db && window.checkOnlineStatus && window.checkOnlineStatus()) {
          try {
            const savingsRef = window.firestoreDoc(window.firestoreCollection(db, 'familySavings'), 'userSavings');
            const docSnap = await window.firestoreGetDoc(savingsRef);
            
            if (docSnap.exists()) {
              const firebaseData = docSnap.data();
              state = {
                initialMarriedCount: firebaseData.initialMarriedCount || 0,
                annualYield: firebaseData.annualYield || 0,
                contributionPerMarriedChild: firebaseData.contributionPerMarriedChild || 0,
                weddingCosts: firebaseData.weddingCosts || INITIAL_WEDDING_COSTS,
                childrenAges: firebaseData.childrenAges || INITIAL_CHILDREN_AGES
              };
              
              // Local backup
              localStorage.setItem(STATE_KEY, JSON.stringify(state));
              console.log('Data loaded from Firebase');
            }
          } catch (firebaseError) {
            console.warn('Error loading from Firebase:', firebaseError);
          }
        }
        
        // If not loaded from Firebase, load locally
        if (!state) {
          const raw = localStorage.getItem(STATE_KEY);
          if (!raw) return getDefaultState();
          
          const parsed = JSON.parse(raw);
          const safe = getDefaultState();
          
          if (typeof parsed.initialMarriedCount === 'number') safe.initialMarriedCount = parsed.initialMarriedCount;
          if (typeof parsed.annualYield === 'number') safe.annualYield = parsed.annualYield;
          if (typeof parsed.contributionPerMarriedChild === 'number') safe.contributionPerMarriedChild = parsed.contributionPerMarriedChild;
          if (Array.isArray(parsed.weddingCosts) && parsed.weddingCosts.length === INITIAL_WEDDING_COSTS.length) {
            safe.weddingCosts = parsed.weddingCosts.map(n => Number.isFinite(n) ? n : 0);
          }
          if (Array.isArray(parsed.childrenAges) && parsed.childrenAges.length === INITIAL_CHILDREN_AGES.length) {
            safe.childrenAges = parsed.childrenAges.map(n => Number.isFinite(n) ? n : 0);
          }
          
          state = safe;
        }
        
        return state;
      } catch (e) {
        console.warn('Failed loading saved state, using defaults', e);
        return getDefaultState();
      }
    }

    function getStateFromDOM() {
      return {
        initialMarriedCount: parseFloat(initialMarriedCountEl.value) || 0,
        annualYield: parseFloat(annualYieldEl.value) || 0,
        contributionPerMarriedChild: parseFloat(contributionPerMarriedChildEl.value) || 0,
        weddingCosts: weddingCostInputs.map(i => parseFloat(i.value) || 0),
        childrenAges: childrenAgeInputs.map(i => parseFloat(i.value) || 0),
      };
    }

    async function saveState() {
      try {
        const state = getStateFromDOM();
        
        // Local save
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
        
        // Firebase save if available
        if (isFirebaseEnabled && db && window.checkOnlineStatus && window.checkOnlineStatus()) {
          try {
            const savingsRef = window.firestoreDoc(window.firestoreCollection(db, 'familySavings'), 'userSavings');
            await window.firestoreSetDoc(savingsRef, {
              ...state,
              updatedAt: new Date().toISOString(),
              timestamp: new Date()
            });
          } catch (firebaseError) {
            console.warn('Error saving to Firebase:', firebaseError);
          }
        }
      } catch (e) {
        console.warn('Failed saving state', e);
      }
    }

    function applyStateToDOM(state) {
      // Scalars
      initialMarriedCountEl.value = state.initialMarriedCount;
      annualYieldEl.value = state.annualYield;
      contributionPerMarriedChildEl.value = state.contributionPerMarriedChild;
      // Arrays - apply after inputs exist (we call this after create* functions)
      if (weddingCostInputs.length === state.weddingCosts.length) {
        weddingCostInputs.forEach((input, idx) => { input.value = state.weddingCosts[idx]; });
      }
      if (childrenAgeInputs.length === state.childrenAges.length) {
        childrenAgeInputs.forEach((input, idx) => { input.value = state.childrenAges[idx]; });
      }
    }

    function resetSavedState() {
      localStorage.removeItem(STATE_KEY);
      // Reset DOM to defaults and re-render
      const def = getDefaultState();
      applyStateToDOM({ ...def, weddingCosts: def.weddingCosts.slice(), childrenAges: def.childrenAges.slice() });
      calculateAndRender();
      saveState();
    }
    
    function createChildrenAgeInputs() {
      let html = '';
      INITIAL_CHILDREN_AGES.forEach((age, index) => {
        html += `
          <div>
            <label for="childAge${index}" class="block text-xs font-medium text-gray-600">ילד #${index + 1} (גיל)</label>
            <input type="number" id="childAge${index}" value="${age}" class="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm">
          </div>`;
      });
      childrenAgesContainer.innerHTML = html;
      childrenAgeInputs = INITIAL_CHILDREN_AGES.map((_, i) => document.getElementById(`childAge${i}`));
    }
        
    function createWeddingCostInputs() {
      let html = '';
      INITIAL_WEDDING_COSTS.forEach((cost, index) => {
        html += `
          <div>
            <label for="weddingCost${index}" class="block text-xs font-medium text-gray-600">חתונה (ילד #${index + 1})</label>
            <input type="number" id="weddingCost${index}" value="${cost}" class="mt-1 block w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm">
          </div>`;
      });
      weddingCostsContainer.innerHTML = html;
      weddingCostInputs = INITIAL_WEDDING_COSTS.map((_, i) => document.getElementById(`weddingCost${i}`));
    }

    function calculateAndRender() {
      const initialMarriedCount = parseFloat(initialMarriedCountEl.value) || 0;
      const annualYield = parseFloat(annualYieldEl.value) || 0;
      const monthlyContribution = parseFloat(contributionPerMarriedChildEl.value) || 0;
      const weddingCosts = weddingCostInputs.map(input => parseFloat(input.value) || 0);
      const currentAges = childrenAgeInputs.map(input => parseFloat(input.value) || 0);

      const unmarriedChildren = currentAges.map((age, index) => ({ id: index, currentAge: age, weddingYear: WEDDING_AGE - age })).sort((a, b) => a.weddingYear - b.weddingYear);

      resultsTableBody.innerHTML = '';
      let openingBalance = 0;
            
      for (let year = 0; year <= TOTAL_YEARS; year++) {
        const newlyMarriedCount = unmarriedChildren.filter(c => c.weddingYear < year).length;
        const totalMarriedCount = initialMarriedCount + newlyMarriedCount;
        const annualChildrenIncome = totalMarriedCount * monthlyContribution * 12;

        let netWeddingCost = 0;
        if (year > 0) {
          const childGettingMarried = unmarriedChildren.find(c => c.weddingYear === year);
          if (childGettingMarried) { netWeddingCost = weddingCosts[childGettingMarried.id] || 0; }
        }

        const principalForGrowth = openingBalance + annualChildrenIncome / 2;
        const growth = principalForGrowth * (annualYield / 100);

        if (openingBalance + annualChildrenIncome + growth - netWeddingCost < 0) {
          netWeddingCost = openingBalance + annualChildrenIncome + growth;
        }

        const closingBalance = openingBalance + annualChildrenIncome + growth - netWeddingCost;

        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50 text-center';
        const closingBalanceColor = closingBalance >= 0 ? 'text-green-600' : 'text-red-600';
        row.innerHTML = `
          <td class="p-3 border-r font-semibold text-gray-800">${year}</td>
          <td class="p-3 border-r text-gray-600">${formatCurrency(openingBalance)}</td>
          <td class="p-3 border-r text-cyan-600">${formatCurrency(annualChildrenIncome)}</td>
          <td class="p-3 border-r text-purple-600">${formatCurrency(growth)}</td>
          <td class="p-3 border-r text-red-500">${formatCurrency(netWeddingCost)}</td>
          <td class="p-3 font-bold ${closingBalanceColor}">${formatCurrency(closingBalance)}</td>`;
        resultsTableBody.appendChild(row);

        openingBalance = closingBalance;
      }
    }

    async function initialize() {
      // Initialize Firebase first
      await initializeFirebase();
      
      // Build inputs
      createChildrenAgeInputs();
      createWeddingCostInputs();
      
      // Load: try cloud first, fallback to local
      let state = await loadState();
      applyStateToDOM(state);
      
      // Events: recalc + save on any change (local + debounced cloud)
      const allInputs = [initialMarriedCountEl, annualYieldEl, contributionPerMarriedChildEl, ...weddingCostInputs, ...childrenAgeInputs];
      allInputs.forEach(input => {
        input.addEventListener('input', () => { 
          calculateAndRender(); 
          saveState(); 
        });
      });
      
      // Initial render and save (also schedule cloud save)
      calculateAndRender();
      await saveState();
      
      // Save on unload as well
      window.addEventListener('beforeunload', saveState);
    }

    document.addEventListener('DOMContentLoaded', () => { initialize(); });
  </script>
</body>
</html>